{
  "instance_id": "astropy__astropy-12907",
  "variant": "oracle",
  "split": "test",
  "meta": {
    "instance_id": "astropy__astropy-12907",
    "repo": "astropy/astropy",
    "base_commit": "d16bfe05a744909de4b27f5875fe0d4ed41ce607",
    "patch": "<patch>\ndiff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -242,7 +242,7 @@ def _cstack(left, right):\n         cright = _coord_matrix(right, 'right', noutp)\n     else:\n         cright = np.zeros((noutp, right.shape[1]))\n-        cright[-right.shape[0]:, -right.shape[1]:] = 1\n+        cright[-right.shape[0]:, -right.shape[1]:] = right\n \n     return np.hstack([cleft, cright])\n \n\n</patch>",
    "test_patch": "diff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py\n--- a/astropy/modeling/tests/test_separable.py\n+++ b/astropy/modeling/tests/test_separable.py\n@@ -28,6 +28,13 @@\n p1 = models.Polynomial1D(1, name='p1')\n \n \n+cm_4d_expected = (np.array([False, False, True, True]),\n+                  np.array([[True,  True,  False, False],\n+                            [True,  True,  False, False],\n+                            [False, False, True,  False],\n+                            [False, False, False, True]]))\n+\n+\n compound_models = {\n     'cm1': (map3 & sh1 | rot & sh1 | sh1 & sh2 & sh1,\n             (np.array([False, False, True]),\n@@ -52,7 +59,17 @@\n     'cm7': (map2 | p2 & sh1,\n             (np.array([False, True]),\n              np.array([[True, False], [False, True]]))\n-            )\n+            ),\n+    'cm8': (rot & (sh1 & sh2), cm_4d_expected),\n+    'cm9': (rot & sh1 & sh2, cm_4d_expected),\n+    'cm10': ((rot & sh1) & sh2, cm_4d_expected),\n+    'cm11': (rot & sh1 & (scl1 & scl2),\n+             (np.array([False, False, True, True, True]),\n+              np.array([[True,  True,  False, False, False],\n+                        [True,  True,  False, False, False],\n+                        [False, False, True,  False, False],\n+                        [False, False, False, True,  False],\n+                        [False, False, False, False, True]]))),\n }\n \n \n",
    "created_at": "2022-03-03T15:14:54Z",
    "version": "4.3",
    "FAIL_TO_PASS": "[\"astropy/modeling/tests/test_separable.py::test_separable[compound_model6-result6]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model9-result9]\"]",
    "PASS_TO_PASS": "[\"astropy/modeling/tests/test_separable.py::test_coord_matrix\", \"astropy/modeling/tests/test_separable.py::test_cdot\", \"astropy/modeling/tests/test_separable.py::test_cstack\", \"astropy/modeling/tests/test_separable.py::test_arith_oper\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model0-result0]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model1-result1]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model2-result2]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model3-result3]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model4-result4]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model5-result5]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model7-result7]\", \"astropy/modeling/tests/test_separable.py::test_separable[compound_model8-result8]\", \"astropy/modeling/tests/test_separable.py::test_custom_model_separable\"]"
  },
  "text": "You will be provided with a partial code base and an issue statement explaining a problem to resolve.\n<issue>\nModeling's `separability_matrix` does not compute separability correctly for nested CompoundModels\nConsider the following model:\r\n\r\n```python\r\nfrom astropy.modeling import models as m\r\nfrom astropy.modeling.separable import separability_matrix\r\n\r\ncm = m.Linear1D(10) & m.Linear1D(5)\r\n```\r\n\r\nIt's separability matrix as you might expect is a diagonal:\r\n\r\n```python\r\n>>> separability_matrix(cm)\r\narray([[ True, False],\r\n       [False,  True]])\r\n```\r\n\r\nIf I make the model more complex:\r\n```python\r\n>>> separability_matrix(m.Pix2Sky_TAN() & m.Linear1D(10) & m.Linear1D(5))\r\narray([[ True,  True, False, False],\r\n       [ True,  True, False, False],\r\n       [False, False,  True, False],\r\n       [False, False, False,  True]])\r\n```\r\n\r\nThe output matrix is again, as expected, the outputs and inputs to the linear models are separable and independent of each other.\r\n\r\nIf however, I nest these compound models:\r\n```python\r\n>>> separability_matrix(m.Pix2Sky_TAN() & cm)\r\narray([[ True,  True, False, False],\r\n       [ True,  True, False, False],\r\n       [False, False,  True,  True],\r\n       [False, False,  True,  True]])\r\n```\r\nSuddenly the inputs and outputs are no longer separable?\r\n\r\nThis feels like a bug to me, but I might be missing something?\n\n</issue>\n<code>\n[start of README.rst]\n1 =======\n2 Astropy\n3 =======\n4 \n5 |Actions Status| |CircleCI Status| |Azure Status| |Coverage Status| |PyPI Status| |Documentation Status| |Zenodo|\n6 \n7 The Astropy Project (http://astropy.org/) is a community effort to develop a\n8 single core package for Astronomy in Python and foster interoperability between\n9 Python astronomy packages. This repository contains the core package which is\n10 intended to contain much of the core functionality and some common tools needed\n11 for performing astronomy and astrophysics with Python.\n12 \n13 Releases are `registered on PyPI <https://pypi.org/project/astropy>`_,\n14 and development is occurring at the\n15 `project's GitHub page <http://github.com/astropy/astropy>`_.\n16 \n17 For installation instructions, see the `online documentation <https://docs.astropy.org/>`_\n18 or  `docs/install.rst <docs/install.rst>`_ in this source distribution.\n19 \n20 Contributing Code, Documentation, or Feedback\n21 ---------------------------------------------\n22 \n23 The Astropy Project is made both by and for its users, so we welcome and\n24 encourage contributions of many kinds. Our goal is to keep this a positive,\n25 inclusive, successful, and growing community by abiding with the\n26 `Astropy Community Code of Conduct <http://www.astropy.org/about.html#codeofconduct>`_.\n27 \n28 More detailed information on contributing to the project or submitting feedback\n29 can be found on the `contributions <http://www.astropy.org/contribute.html>`_\n30 page. A `summary of contribution guidelines <CONTRIBUTING.md>`_ can also be\n31 used as a quick reference when you are ready to start writing or validating\n32 code for submission.\n33 \n34 Supporting the Project\n35 ----------------------\n36 \n37 |NumFOCUS| |Donate|\n38 \n39 The Astropy Project is sponsored by NumFOCUS, a 501(c)(3) nonprofit in the\n40 United States. You can donate to the project by using the link above, and this\n41 donation will support our mission to promote sustainable, high-level code base\n42 for the astronomy community, open code development, educational materials, and\n43 reproducible scientific research.\n44 \n45 License\n46 -------\n47 \n48 Astropy is licensed under a 3-clause BSD style license - see the\n49 `LICENSE.rst <LICENSE.rst>`_ file.\n50 \n51 .. |Actions Status| image:: https://github.com/astropy/astropy/workflows/CI/badge.svg\n52     :target: https://github.com/astropy/astropy/actions\n53     :alt: Astropy's GitHub Actions CI Status\n54 \n55 .. |CircleCI Status| image::  https://img.shields.io/circleci/build/github/astropy/astropy/main?logo=circleci&label=CircleCI\n56     :target: https://circleci.com/gh/astropy/astropy\n57     :alt: Astropy's CircleCI Status\n58 \n59 .. |Azure Status| image:: https://dev.azure.com/astropy-project/astropy/_apis/build/status/astropy.astropy?repoName=astropy%2Fastropy&branchName=main\n60     :target: https://dev.azure.com/astropy-project/astropy\n61     :alt: Astropy's Azure Pipelines Status\n62 \n63 .. |Coverage Status| image:: https://codecov.io/gh/astropy/astropy/branch/main/graph/badge.svg\n64     :target: https://codecov.io/gh/astropy/astropy\n65     :alt: Astropy's Coverage Status\n66 \n67 .. |PyPI Status| image:: https://img.shields.io/pypi/v/astropy.svg\n68     :target: https://pypi.org/project/astropy\n69     :alt: Astropy's PyPI Status\n70 \n71 .. |Zenodo| image:: https://zenodo.org/badge/DOI/10.5281/zenodo.4670728.svg\n72    :target: https://doi.org/10.5281/zenodo.4670728\n73    :alt: Zenodo DOI\n74 \n75 .. |Documentation Status| image:: https://img.shields.io/readthedocs/astropy/latest.svg?logo=read%20the%20docs&logoColor=white&label=Docs&version=stable\n76     :target: https://docs.astropy.org/en/stable/?badge=stable\n77     :alt: Documentation Status\n78 \n79 .. |NumFOCUS| image:: https://img.shields.io/badge/powered%20by-NumFOCUS-orange.svg?style=flat&colorA=E1523D&colorB=007D8A\n80     :target: http://numfocus.org\n81     :alt: Powered by NumFOCUS\n82 \n83 .. |Donate| image:: https://img.shields.io/badge/Donate-to%20Astropy-brightgreen.svg\n84     :target: https://numfocus.salsalabs.org/donate-to-astropy/index.html\n85 \n86 \n87 If you locally cloned this repo before 7 Apr 2021\n88 -------------------------------------------------\n89 \n90 The primary branch for this repo has been transitioned from ``master`` to\n91 ``main``.  If you have a local clone of this repository and want to keep your\n92 local branch in sync with this repo, you'll need to do the following in your\n93 local clone from your terminal::\n94 \n95    git fetch --all --prune\n96    # you can stop here if you don't use your local \"master\"/\"main\" branch\n97    git branch -m master main\n98    git branch -u origin/main main\n99 \n100 If you are using a GUI to manage your repos you'll have to find the equivalent\n101 commands as it's different for different programs. Alternatively, you can just\n102 delete your local clone and re-clone!\n103 \n[end of README.rst]\n[start of astropy/modeling/separable.py]\n1 # Licensed under a 3-clause BSD style license - see LICENSE.rst\n2 \n3 \"\"\"\n4 Functions to determine if a model is separable, i.e.\n5 if the model outputs are independent.\n6 \n7 It analyzes ``n_inputs``, ``n_outputs`` and the operators\n8 in a compound model by stepping through the transforms\n9 and creating a ``coord_matrix`` of shape (``n_outputs``, ``n_inputs``).\n10 \n11 \n12 Each modeling operator is represented by a function which\n13 takes two simple models (or two ``coord_matrix`` arrays) and\n14 returns an array of shape (``n_outputs``, ``n_inputs``).\n15 \n16 \"\"\"\n17 \n18 import numpy as np\n19 \n20 from .core import Model, ModelDefinitionError, CompoundModel\n21 from .mappings import Mapping\n22 \n23 \n24 __all__ = [\"is_separable\", \"separability_matrix\"]\n25 \n26 \n27 def is_separable(transform):\n28     \"\"\"\n29     A separability test for the outputs of a transform.\n30 \n31     Parameters\n32     ----------\n33     transform : `~astropy.modeling.core.Model`\n34         A (compound) model.\n35 \n36     Returns\n37     -------\n38     is_separable : ndarray\n39         A boolean array with size ``transform.n_outputs`` where\n40         each element indicates whether the output is independent\n41         and the result of a separable transform.\n42 \n43     Examples\n44     --------\n45     >>> from astropy.modeling.models import Shift, Scale, Rotation2D, Polynomial2D\n46     >>> is_separable(Shift(1) & Shift(2) | Scale(1) & Scale(2))\n47         array([ True,  True]...)\n48     >>> is_separable(Shift(1) & Shift(2) | Rotation2D(2))\n49         array([False, False]...)\n50     >>> is_separable(Shift(1) & Shift(2) | Mapping([0, 1, 0, 1]) | \\\n51         Polynomial2D(1) & Polynomial2D(2))\n52         array([False, False]...)\n53     >>> is_separable(Shift(1) & Shift(2) | Mapping([0, 1, 0, 1]))\n54         array([ True,  True,  True,  True]...)\n55 \n56     \"\"\"\n57     if transform.n_inputs == 1 and transform.n_outputs > 1:\n58         is_separable = np.array([False] * transform.n_outputs).T\n59         return is_separable\n60     separable_matrix = _separable(transform)\n61     is_separable = separable_matrix.sum(1)\n62     is_separable = np.where(is_separable != 1, False, True)\n63     return is_separable\n64 \n65 \n66 def separability_matrix(transform):\n67     \"\"\"\n68     Compute the correlation between outputs and inputs.\n69 \n70     Parameters\n71     ----------\n72     transform : `~astropy.modeling.core.Model`\n73         A (compound) model.\n74 \n75     Returns\n76     -------\n77     separable_matrix : ndarray\n78         A boolean correlation matrix of shape (n_outputs, n_inputs).\n79         Indicates the dependence of outputs on inputs. For completely\n80         independent outputs, the diagonal elements are True and\n81         off-diagonal elements are False.\n82 \n83     Examples\n84     --------\n85     >>> from astropy.modeling.models import Shift, Scale, Rotation2D, Polynomial2D\n86     >>> separability_matrix(Shift(1) & Shift(2) | Scale(1) & Scale(2))\n87         array([[ True, False], [False,  True]]...)\n88     >>> separability_matrix(Shift(1) & Shift(2) | Rotation2D(2))\n89         array([[ True,  True], [ True,  True]]...)\n90     >>> separability_matrix(Shift(1) & Shift(2) | Mapping([0, 1, 0, 1]) | \\\n91         Polynomial2D(1) & Polynomial2D(2))\n92         array([[ True,  True], [ True,  True]]...)\n93     >>> separability_matrix(Shift(1) & Shift(2) | Mapping([0, 1, 0, 1]))\n94         array([[ True, False], [False,  True], [ True, False], [False,  True]]...)\n95 \n96     \"\"\"\n97     if transform.n_inputs == 1 and transform.n_outputs > 1:\n98         return np.ones((transform.n_outputs, transform.n_inputs),\n99                        dtype=np.bool_)\n100     separable_matrix = _separable(transform)\n101     separable_matrix = np.where(separable_matrix != 0, True, False)\n102     return separable_matrix\n103 \n104 \n105 def _compute_n_outputs(left, right):\n106     \"\"\"\n107     Compute the number of outputs of two models.\n108 \n109     The two models are the left and right model to an operation in\n110     the expression tree of a compound model.\n111 \n112     Parameters\n113     ----------\n114     left, right : `astropy.modeling.Model` or ndarray\n115         If input is of an array, it is the output of `coord_matrix`.\n116 \n117     \"\"\"\n118     if isinstance(left, Model):\n119         lnout = left.n_outputs\n120     else:\n121         lnout = left.shape[0]\n122     if isinstance(right, Model):\n123         rnout = right.n_outputs\n124     else:\n125         rnout = right.shape[0]\n126     noutp = lnout + rnout\n127     return noutp\n128 \n129 \n130 def _arith_oper(left, right):\n131     \"\"\"\n132     Function corresponding to one of the arithmetic operators\n133     ['+', '-'. '*', '/', '**'].\n134 \n135     This always returns a nonseparable output.\n136 \n137 \n138     Parameters\n139     ----------\n140     left, right : `astropy.modeling.Model` or ndarray\n141         If input is of an array, it is the output of `coord_matrix`.\n142 \n143     Returns\n144     -------\n145     result : ndarray\n146         Result from this operation.\n147     \"\"\"\n148     # models have the same number of inputs and outputs\n149     def _n_inputs_outputs(input):\n150         if isinstance(input, Model):\n151             n_outputs, n_inputs = input.n_outputs, input.n_inputs\n152         else:\n153             n_outputs, n_inputs = input.shape\n154         return n_inputs, n_outputs\n155 \n156     left_inputs, left_outputs = _n_inputs_outputs(left)\n157     right_inputs, right_outputs = _n_inputs_outputs(right)\n158 \n159     if left_inputs != right_inputs or left_outputs != right_outputs:\n160         raise ModelDefinitionError(\n161             \"Unsupported operands for arithmetic operator: left (n_inputs={}, \"\n162             \"n_outputs={}) and right (n_inputs={}, n_outputs={}); \"\n163             \"models must have the same n_inputs and the same \"\n164             \"n_outputs for this operator.\".format(\n165                 left_inputs, left_outputs, right_inputs, right_outputs))\n166 \n167     result = np.ones((left_outputs, left_inputs))\n168     return result\n169 \n170 \n171 def _coord_matrix(model, pos, noutp):\n172     \"\"\"\n173     Create an array representing inputs and outputs of a simple model.\n174 \n175     The array has a shape (noutp, model.n_inputs).\n176 \n177     Parameters\n178     ----------\n179     model : `astropy.modeling.Model`\n180         model\n181     pos : str\n182         Position of this model in the expression tree.\n183         One of ['left', 'right'].\n184     noutp : int\n185         Number of outputs of the compound model of which the input model\n186         is a left or right child.\n187 \n188     \"\"\"\n189     if isinstance(model, Mapping):\n190         axes = []\n191         for i in model.mapping:\n192             axis = np.zeros((model.n_inputs,))\n193             axis[i] = 1\n194             axes.append(axis)\n195         m = np.vstack(axes)\n196         mat = np.zeros((noutp, model.n_inputs))\n197         if pos == 'left':\n198             mat[: model.n_outputs, :model.n_inputs] = m\n199         else:\n200             mat[-model.n_outputs:, -model.n_inputs:] = m\n201         return mat\n202     if not model.separable:\n203         # this does not work for more than 2 coordinates\n204         mat = np.zeros((noutp, model.n_inputs))\n205         if pos == 'left':\n206             mat[:model.n_outputs, : model.n_inputs] = 1\n207         else:\n208             mat[-model.n_outputs:, -model.n_inputs:] = 1\n209     else:\n210         mat = np.zeros((noutp, model.n_inputs))\n211 \n212         for i in range(model.n_inputs):\n213             mat[i, i] = 1\n214         if pos == 'right':\n215             mat = np.roll(mat, (noutp - model.n_outputs))\n216     return mat\n217 \n218 \n219 def _cstack(left, right):\n220     \"\"\"\n221     Function corresponding to '&' operation.\n222 \n223     Parameters\n224     ----------\n225     left, right : `astropy.modeling.Model` or ndarray\n226         If input is of an array, it is the output of `coord_matrix`.\n227 \n228     Returns\n229     -------\n230     result : ndarray\n231         Result from this operation.\n232 \n233     \"\"\"\n234     noutp = _compute_n_outputs(left, right)\n235 \n236     if isinstance(left, Model):\n237         cleft = _coord_matrix(left, 'left', noutp)\n238     else:\n239         cleft = np.zeros((noutp, left.shape[1]))\n240         cleft[: left.shape[0], : left.shape[1]] = left\n241     if isinstance(right, Model):\n242         cright = _coord_matrix(right, 'right', noutp)\n243     else:\n244         cright = np.zeros((noutp, right.shape[1]))\n245         cright[-right.shape[0]:, -right.shape[1]:] = 1\n246 \n247     return np.hstack([cleft, cright])\n248 \n249 \n250 def _cdot(left, right):\n251     \"\"\"\n252     Function corresponding to \"|\" operation.\n253 \n254     Parameters\n255     ----------\n256     left, right : `astropy.modeling.Model` or ndarray\n257         If input is of an array, it is the output of `coord_matrix`.\n258 \n259     Returns\n260     -------\n261     result : ndarray\n262         Result from this operation.\n263     \"\"\"\n264 \n265     left, right = right, left\n266 \n267     def _n_inputs_outputs(input, position):\n268         \"\"\"\n269         Return ``n_inputs``, ``n_outputs`` for a model or coord_matrix.\n270         \"\"\"\n271         if isinstance(input, Model):\n272             coords = _coord_matrix(input, position, input.n_outputs)\n273         else:\n274             coords = input\n275         return coords\n276 \n277     cleft = _n_inputs_outputs(left, 'left')\n278     cright = _n_inputs_outputs(right, 'right')\n279 \n280     try:\n281         result = np.dot(cleft, cright)\n282     except ValueError:\n283         raise ModelDefinitionError(\n284             'Models cannot be combined with the \"|\" operator; '\n285             'left coord_matrix is {}, right coord_matrix is {}'.format(\n286                 cright, cleft))\n287     return result\n288 \n289 \n290 def _separable(transform):\n291     \"\"\"\n292     Calculate the separability of outputs.\n293 \n294     Parameters\n295     ----------\n296     transform : `astropy.modeling.Model`\n297         A transform (usually a compound model).\n298 \n299     Returns :\n300     is_separable : ndarray of dtype np.bool\n301         An array of shape (transform.n_outputs,) of boolean type\n302         Each element represents the separablity of the corresponding output.\n303     \"\"\"\n304     if (transform_matrix := transform._calculate_separability_matrix()) is not NotImplemented:\n305         return transform_matrix\n306     elif isinstance(transform, CompoundModel):\n307         sepleft = _separable(transform.left)\n308         sepright = _separable(transform.right)\n309         return _operators[transform.op](sepleft, sepright)\n310     elif isinstance(transform, Model):\n311         return _coord_matrix(transform, 'left', transform.n_outputs)\n312 \n313 \n314 # Maps modeling operators to a function computing and represents the\n315 # relationship of axes as an array of 0-es and 1-s\n316 _operators = {'&': _cstack, '|': _cdot, '+': _arith_oper, '-': _arith_oper,\n317               '*': _arith_oper, '/': _arith_oper, '**': _arith_oper}\n318 \n[end of astropy/modeling/separable.py]\n</code>\nI need you to solve this issue by generating a single patch file that I can apply directly to this repository using git apply. Please respond with a single patch file in the following format.\n<patch>\n--- a/file.py\n+++ b/file.py\n@@ -1,27 +1,35 @@\n def euclidean(a, b):\n-    while b:\n-        a, b = b, a % b\n-    return a\n+    if b == 0:\n+        return a\n+    return euclidean(b, a % b)\n \n \n def bresenham(x0, y0, x1, y1):\n     points = []\n     dx = abs(x1 - x0)\n     dy = abs(y1 - y0)\n-    sx = 1 if x0 < x1 else -1\n-    sy = 1 if y0 < y1 else -1\n-    err = dx - dy\n+    x, y = x0, y0\n+    sx = -1 if x0 > x1 else 1\n+    sy = -1 if y0 > y1 else 1\n \n-    while True:\n-        points.append((x0, y0))\n-        if x0 == x1 and y0 == y1:\n-            break\n-        e2 = 2 * err\n-        if e2 > -dy:\n+    if dx > dy:\n+        err = dx / 2.0\n+        while x != x1:\n+            points.append((x, y))\n             err -= dy\n-            x0 += sx\n-        if e2 < dx:\n-            err += dx\n-            y0 += sy\n+            if err < 0:\n+                y += sy\n+                err += dx\n+            x += sx\n+    else:\n+        err = dy / 2.0\n+        while y != y1:\n+            points.append((x, y))\n+            err -= dx\n+            if err < 0:\n+                x += sx\n+                err += dy\n+            y += sy\n \n+    points.append((x, y))\n     return points\n</patch>\n\n"
}